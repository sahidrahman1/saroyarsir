<!-- Fee Management Component -->
<div class="space-y-6" x-data="feeManager()" x-init="init()">
    <!-- VERSION: 2.0 - Fixed monthly-save endpoint -->
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Fee Management</h2>
            <p class="text-gray-600">Manage monthly fees for students in each batch</p>
        </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-lg shadow">
        <!-- Tabs -->
        <div class="border-b border-gray-200 bg-white px-6">
            <nav class="-mb-px flex space-x-8">
                <button @click="activeTab = 'entry'" 
                        :class="activeTab === 'entry' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Fee Entry
                </button>
                <button @click="activeTab = 'overview'" 
                        :class="activeTab === 'overview' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Monthly Overview
                </button>
            </nav>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Fee Entry Tab -->
            <div x-show="activeTab === 'entry'" x-cloak>
                <!-- Selection -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Batch</label>
                            <select x-model="selectedBatch" @change="loadStudents()"
                                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">-- Choose Batch --</option>
                                <template x-for="batch in batches" :key="batch.batch_id || batch.id">
                                    <option :value="batch.batch_id || batch.id" x-text="`${batch.name || batch.batch_name} (${batch.student_count || 0} students)`"></option>
                                </template>
                            </select>
                            <p x-show="batches.length > 0" class="mt-1 text-xs text-gray-600" x-text="`${batches.length} batches available`"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Academic Year</label>
                            <select x-model="selectedYear"
                                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <template x-for="year in years" :key="year">
                                    <option :value="year" x-text="year"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div x-show="loading" class="flex justify-center items-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>

                <!-- Error -->
                <div x-show="error" x-cloak class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm text-red-700" x-text="error"></p>
                            <div x-show="error.includes('log in') || error.includes('Access denied')" class="mt-2">
                                <a href="/login" class="text-sm bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-md">
                                    Go to Login
                                </a>
                            </div>
                        </div>
                        <button @click="error = ''" class="text-red-500 hover:text-red-700 font-bold">
                            Ã—
                        </button>
                    </div>
                </div>

                <!-- Empty -->
                <div x-show="!loading && !selectedBatch" x-cloak class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No Batch Selected</h3>
                    <p class="mt-1 text-sm text-gray-500">Select a batch to view and manage student fees</p>
                </div>

                <!-- No Students -->
                <div x-show="!loading && selectedBatch && students.length === 0" x-cloak class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No Students Found</h3>
                    <p class="mt-1 text-sm text-gray-500">This batch doesn't have any students yet</p>
                </div>

                <!-- Table -->
                <div x-show="!loading && selectedBatch && students.length > 0" x-cloak class="overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">
                            Fee Details <span class="text-sm font-normal text-gray-500">(<span x-text="students.length"></span> students)</span>
                        </h3>
                        <div class="flex space-x-2">
                            <button @click="downloadTable()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Download
                            </button>
                            <button @click="saveAll()" :disabled="saving"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center">
                                <span x-show="!saving">Save All Changes</span>
                                <span x-show="saving">Saving...</span>
                            </button>
                        </div>
                    </div>

                    <table class="min-w-full divide-y divide-gray-200 border rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50">Student</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jan</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Feb</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Mar</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Apr</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">May</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jun</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jul</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aug</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Sep</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Oct</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Nov</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Dec</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase bg-blue-50">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="student in students" :key="student.student_id || student.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900 sticky left-0 bg-white" x-text="student.full_name || student.first_name + ' ' + student.last_name || student.name"></td>
                                    <template x-for="month in [1,2,3,4,5,6,7,8,9,10,11,12]" :key="month">
                                        <td class="px-2 py-3 text-center">
                                            <input type="number" :value="getFee(student, month)" @input="updateFee(student, month, $event.target.value)"
                                                   class="w-20 px-2 py-1 text-sm border rounded focus:ring-2 focus:ring-blue-500 text-center" placeholder="0" min="0">
                                        </td>
                                    </template>
                                    <td class="px-4 py-3 text-center text-sm font-semibold bg-blue-50" x-text="calculateTotal(student)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Overview Tab -->
            <div x-show="activeTab === 'overview'" x-cloak>
                <div class="text-center py-12">
                    <h3 class="text-sm font-medium text-gray-900">Monthly Overview</h3>
                    <p class="mt-1 text-sm text-gray-500">View monthly fee collection statistics</p>
                    <p class="mt-4 text-xs text-gray-400">Coming soon...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function feeManager() {
    return {
        activeTab: 'entry',
        batches: [],
        students: [],
        fees: {},
        selectedBatch: '',
        selectedYear: new Date().getFullYear(),
        years: [new Date().getFullYear(), new Date().getFullYear() + 1, new Date().getFullYear() - 1, new Date().getFullYear() + 2],
        loading: false,
        saving: false,
        error: '',
        
        init() {
            console.log('ðŸš€ Fee Manager initialized');
            this.error = ''; // Clear any cached errors
            this.message = ''; // Clear any cached messages
            this.checkAuthAndLoad();
        },
        
        async checkAuthAndLoad() {
            try {
                // Test if user is authenticated by checking a simple API
                const response = await fetch('/api/dashboard/stats', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication required');
                }
                
                await this.loadBatches();
            } catch (err) {
                console.error('Auth check failed:', err);
                this.error = 'Please log in as a teacher to access fee management';
            }
        },
        
        async loadBatches() {
            console.log('Loading batches...');
            this.error = '';
            try {
                const response = await fetch('/api/batches', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Access denied. Please log in as a teacher.');
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to load batches (${response.status})`);
                }
                
                const data = await response.json();
                console.log('Raw batches response:', data);
                
                // Handle different response formats
                if (data.success && data.data) {
                    this.batches = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    this.batches = data;
                } else if (data.batches) {
                    this.batches = Array.isArray(data.batches) ? data.batches : [];
                } else {
                    this.batches = [];
                }
                
                console.log('Processed batches:', this.batches.length);
                
                if (this.batches.length === 0) {
                    this.error = 'No batches found. Please create a batch first.';
                }
            } catch (err) {
                console.error('Error loading batches:', err);
                this.error = err.message || 'Failed to load batches';
            }
        },
        
        async loadStudents() {
            if (!this.selectedBatch) return;
            this.loading = true;
            this.error = '';
            this.students = [];
            try {
                console.log(`Loading students for batch ${this.selectedBatch}`);
                const response = await fetch(`/api/batches/${this.selectedBatch}/students`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Access denied. Teacher login required.');
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to load students (${response.status})`);
                }
                
                const data = await response.json();
                console.log('Raw students response:', data);
                
                // Handle different response formats
                if (data.success && data.data && data.data.students) {
                    this.students = data.data.students;
                } else if (data.students) {
                    this.students = data.students;
                } else if (Array.isArray(data)) {
                    this.students = data;
                } else {
                    this.students = [];
                }
                
                console.log(`Loaded ${this.students.length} students`);
                
                if (this.students.length > 0) {
                    this.error = ''; // Clear any previous errors
                    await this.loadFees();
                } else {
                    this.error = 'No students found in this batch';
                }
            } catch (err) {
                console.error('Error loading students:', err);
                this.error = err.message || 'Failed to load students';
            } finally {
                this.loading = false;
            }
        },
        
        async loadFees() {
            try {
                const response = await fetch(`/api/fees/load-monthly?batch_id=${this.selectedBatch}&year=${this.selectedYear}`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const result = await response.json();
                    
                    // New API format: { success: true, data: { fees: [...], batch_id, year } }
                    if (result.success && result.data && result.data.fees) {
                        this.fees = {};
                        
                        // Parse the new nested format
                        result.data.fees.forEach(studentData => {
                            const studentId = studentData.student_id;
                            const months = studentData.months;
                            
                            // Convert each month's data to our flat structure
                            for (let month = 1; month <= 12; month++) {
                                const monthStr = String(month);
                                const monthData = months[monthStr];
                                const key = `${studentId}_${month}`;
                                
                                this.fees[key] = {
                                    student_id: studentId,
                                    month: month,
                                    year: this.selectedYear,
                                    amount: monthData.amount || 0,
                                    fee_id: monthData.fee_id,
                                    status: monthData.status,
                                    isDirty: false
                                };
                            }
                        });
                        
                        console.log('Loaded fees:', Object.keys(this.fees).length);
                    }
                }
            } catch (err) {
                console.error('Error loading fees:', err);
            }
        },
        
        getFee(student, month) {
            const key = `${student.student_id || student.id}_${month}`;
            return this.fees[key]?.amount || '';
        },
        
        updateFee(student, month, value) {
            const key = `${student.student_id || student.id}_${month}`;
            if (!this.fees[key]) {
                this.fees[key] = {
                    student_id: student.student_id || student.id,
                    month: month,
                    year: this.selectedYear,
                    amount: 0,
                    isDirty: true
                };
            }
            this.fees[key].amount = parseFloat(value) || 0;
            this.fees[key].isDirty = true;
        },
        
        calculateTotal(student) {
            const studentId = student.student_id || student.id;
            let total = 0;
            for (let m = 1; m <= 12; m++) {
                const key = `${studentId}_${m}`;
                total += this.fees[key]?.amount || 0;
            }
            return total.toFixed(2);
        },
        
        async saveAll() {
            this.saving = true;
            this.error = ''; // Clear previous errors
            this.message = ''; // Clear previous messages  
            let savedCount = 0;
            
            try {
                const dirtyFees = Object.values(this.fees).filter(f => f.isDirty);
                console.log('âœ… Dirty fees to save:', dirtyFees.length);
                
                if (dirtyFees.length === 0) {
                    console.log('âš ï¸  No changes to save');
                    this.message = 'No changes to save';
                    this.saving = false;
                    return;
                }
                
                for (const fee of dirtyFees) {
                    const payload = {
                        student_id: fee.student_id,
                        batch_id: this.selectedBatch,
                        month: fee.month,
                        year: fee.year,
                        amount: fee.amount
                    };
                    
                    console.log('Saving fee:', payload);
                    console.log('ðŸ”¥ Calling endpoint: /api/fees/save-monthly');
                    
                    const response = await fetch('/api/fees/save-monthly', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('âœ… Response status:', response.status);
                    console.log('âœ… Response OK:', response.ok);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        
                        if (response.status === 401) {
                            throw new Error('Authentication required. Please log in as a teacher to save fees.');
                        } else if (response.status === 403) {
                            throw new Error('Access denied. Only teachers can manage fees.');
                        } else {
                            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                        }
                    }
                    
                    const result = await response.json();
                    console.log('Save result:', result);
                    
                    if (result.data && result.data.fee) {
                        const savedFee = result.data.fee;
                        if (savedFee.fee_id) fee.fee_id = savedFee.fee_id;
                    }
                    fee.isDirty = false;
                    savedCount++;
                }
                
                // Show success message
                const successMsg = `Successfully saved ${savedCount} fee record${savedCount !== 1 ? 's' : ''}!`;
                console.log(successMsg);
                this.error = ''; // Clear any error
                this.message = successMsg;
                
                // Reload fees to get updated data
                await this.loadFees();
                
            } catch (err) {
                console.error('âŒ Save error:', err);
                console.error('âŒ Error type:', typeof err);
                console.error('âŒ Error message:', err.message);
                console.error('âŒ Full error:', JSON.stringify(err, null, 2));
                this.error = err.message || 'Failed to save fees';
            } finally {
                this.saving = false;
            }
        },

        downloadTable() {
            try {
                if (!this.students || this.students.length === 0) {
                    console.log('No data to download');
                    this.message = 'No data to download';
                    return;
                }

                // Prepare CSV data
                const headers = ['Student Name', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Total'];
                const csvRows = [headers.join(',')];

                // Add student data rows
                this.students.forEach(student => {
                    const row = [
                        `"${student.full_name || student.first_name + ' ' + student.last_name || 'Unknown'}"`,
                        ...Array.from({length: 12}, (_, i) => {
                            const month = i + 1;
                            return this.getFee(student, month) || '0';
                        }),
                        this.calculateTotal(student)
                    ];
                    csvRows.push(row.join(','));
                });

                // Create and download file
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                // Get batch name for filename
                const batchName = this.batches.find(b => (b.id || b.batch_id) == this.selectedBatch)?.name || 'Unknown';
                const filename = `fees_${batchName.replace(/[^a-zA-Z0-9]/g, '_')}_${this.selectedYear}.csv`;
                link.setAttribute('download', filename);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (err) {
                console.error('Download error:', err);
                this.error = 'Failed to download table: ' + err.message;
            }
        }
    };
}
</script>
