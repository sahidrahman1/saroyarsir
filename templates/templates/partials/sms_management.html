<div x-data="smsManagement()" x-init="loadData()" class="flex flex-col h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    
    <!-- Professional Top Bar -->
    <div class="bg-white border-b shadow-sm">
        <div class="px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-3 rounded-lg shadow-md">
                    <i class="fas fa-sms text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">SMS Template Manager</h1>
                    <p class="text-sm text-gray-500">Create and customize SMS templates for automated notifications</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="flex items-center justify-end space-x-2 mb-1">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">SMS Balance</div>
                        <button @click="loadBalance()" class="text-blue-500 hover:text-blue-700" title="Refresh balance">
                            <i class="fas fa-sync-alt text-xs"></i>
                        </button>
                    </div>
                    <div class="text-2xl font-bold" :class="smsCount < 10 ? 'text-red-600' : 'text-green-600'" x-text="smsCount"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content with Sidebar Layout -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar - Template List -->
        <div class="w-80 bg-white border-r overflow-y-auto">
            <div class="p-4">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-800 uppercase text-xs tracking-wide">Templates</h3>
                        <span class="text-xs text-gray-500">3 active</span>
                    </div>
                    <div class="text-xs text-gray-600 bg-blue-50 border border-blue-200 rounded p-2">
                        <i class="fas fa-info-circle text-blue-500"></i> Click to edit ‚Ä¢ Max 130 chars
                    </div>
                </div>

                <!-- Attendance Section -->
                <div class="mb-6">
                    <div class="flex items-center space-x-2 mb-3">
                        <div class="w-1 h-6 bg-green-500 rounded"></div>
                        <h4 class="font-semibold text-gray-700 text-sm">ATTENDANCE</h4>
                    </div>
                    
                    <div @click="selectTemplate('attendance_present')" 
                         :class="selectedTemplateId === 'attendance_present' ? 'bg-blue-50 border-blue-500' : 'bg-gray-50 border-gray-200'"
                         class="border-l-4 rounded-r mb-3 p-3 cursor-pointer hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="bg-green-500 text-white text-xs px-2 py-1 rounded mr-2">‚úì</span>
                                <span class="font-medium text-sm">Present</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-gray-600 line-clamp-2" x-text="templates.find(t => t.id === 'attendance_present')?.message?.substring(0, 60) + '...'"></div>
                    </div>

                    <div @click="selectTemplate('attendance_absent')" 
                         :class="selectedTemplateId === 'attendance_absent' ? 'bg-blue-50 border-blue-500' : 'bg-gray-50 border-gray-200'"
                         class="border-l-4 rounded-r mb-3 p-3 cursor-pointer hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="bg-red-500 text-white text-xs px-2 py-1 rounded mr-2">‚úó</span>
                                <span class="font-medium text-sm">Absent</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-gray-600 line-clamp-2" x-text="templates.find(t => t.id === 'attendance_absent')?.message?.substring(0, 60) + '...'"></div>
                    </div>
                </div>

                <!-- Exam Section -->
                <div class="mb-6">
                    <div class="flex items-center space-x-2 mb-3">
                        <div class="w-1 h-6 bg-blue-500 rounded"></div>
                        <h4 class="font-semibold text-gray-700 text-sm">EXAMS</h4>
                    </div>
                    
                    <div @click="selectTemplate('exam_result')" 
                         :class="selectedTemplateId === 'exam_result' ? 'bg-blue-50 border-blue-500' : 'bg-gray-50 border-gray-200'"
                         class="border-l-4 rounded-r mb-3 p-3 cursor-pointer hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded mr-2">üìù</span>
                                <span class="font-medium text-sm">Exam Result</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-gray-600 line-clamp-2" x-text="templates.find(t => t.id === 'exam_result')?.message?.substring(0, 60) + '...'"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Editor Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Editor Toolbar -->
            <div class="bg-white border-b px-6 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h3 class="font-bold text-gray-800" x-text="getCurrentTemplate()?.name || 'Select a template'"></h3>
                    <span class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full" x-text="'Used in: ' + getCurrentTemplate()?.category"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-sm" :class="editValidation.is_valid ? 'text-green-600' : 'text-red-600'">
                        <i :class="editValidation.is_valid ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
                        <span class="font-mono font-bold" x-text="editValidation.char_count"></span>/130
                    </div>
                    <button @click="saveTemplate()" :disabled="!selectedTemplateId || !editValidation.is_valid || saving" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition text-sm font-medium">
                        <span x-show="!saving"><i class="fas fa-save mr-2"></i>Save Changes</span>
                        <span x-show="saving"><i class="fas fa-spinner fa-spin mr-2"></i>Saving...</span>
                    </button>
                </div>
            </div>

            <!-- Editor Content -->
            <div class="flex-1 overflow-auto bg-gray-50 p-6">
                <div x-show="!selectedTemplateId" class="h-full flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <i class="fas fa-hand-pointer text-6xl mb-4"></i>
                        <p class="text-xl">Select a template from the left sidebar to start editing</p>
                    </div>
                </div>

                <div x-show="selectedTemplateId" class="max-w-4xl mx-auto space-y-6">
                    
                    <!-- Variables Panel -->
                    <div class="bg-white rounded-lg shadow-sm border p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-800 text-sm">Available Variables</h4>
                            <span class="text-xs text-gray-500">Click to insert</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="variable in getCurrentTemplate()?.variables || []" :key="variable">
                                <button type="button" @click="insertVariable(variable)" 
                                        class="px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-md hover:from-blue-600 hover:to-blue-700 text-sm font-medium shadow-sm transition">
                                    <i class="fas fa-plus-circle mr-1"></i>{<span x-text="variable"></span>}
                                </button>
                            </template>
                        </div>
                        <div class="mt-3 text-xs text-gray-600 bg-gray-50 rounded p-2">
                            <strong>üí° Tip:</strong> Variables will be automatically replaced with actual data when SMS is sent
                        </div>
                    </div>

                    <!-- Message Editor -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">Message Template</label>
                        <textarea x-model="editingTemplate.message" @input="validateEditMessage()" 
                                  rows="8" 
                                  class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm transition"
                                  :class="editValidation.is_valid ? 'border-gray-200' : 'border-red-300'"
                                  placeholder="Enter your SMS template here...&#10;&#10;Use variables like {student_name}, {batch_name}, {date}&#10;&#10;Example:&#10;Dear Parent, {student_name} was PRESENT today in {batch_name}."></textarea>
                        
                        <!-- Character Info Bar -->
                        <div class="mt-3 flex justify-between items-center text-sm">
                            <div class="flex items-center space-x-4">
                                <div class="text-gray-600">
                                    <i class="fas fa-keyboard mr-1"></i>
                                    <span class="font-medium" x-text="editingTemplate.message?.length || 0"></span> actual chars
                                </div>
                                <div :class="editValidation.remaining >= 30 ? 'text-green-600' : editValidation.remaining >= 10 ? 'text-yellow-600' : 'text-red-600'">
                                    <i class="fas fa-tachometer-alt mr-1"></i>
                                    <span class="font-medium" x-text="editValidation.remaining"></span> remaining
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">
                                Bengali = 2 chars ‚Ä¢ English = 1 char
                            </div>
                        </div>

                        <!-- Warning -->
                        <div x-show="!editValidation.is_valid" class="mt-3 bg-red-50 border border-red-200 rounded-lg p-3 flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                            <div class="text-sm text-red-700">
                                <strong>Exceeds limit!</strong> Your message is too long. Please reduce by <span x-text="Math.abs(editValidation.remaining)"></span> characters.
                            </div>
                        </div>
                    </div>

                    <!-- Live Preview -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-lg">üì± Live Preview</h4>
                            <span class="text-xs bg-white bg-opacity-20 px-3 py-1 rounded-full">With sample data</span>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur-sm">
                            <div class="text-sm leading-relaxed" x-text="previewTemplate()"></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Send SMS Section -->
            <div class="bg-white border-t p-6 overflow-y-auto max-h-[600px]">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                <i class="fas fa-paper-plane text-green-600 mr-3"></i>
                                Send SMS
                            </h3>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-wallet mr-2"></i>Balance: <span class="font-bold text-green-600" x-text="smsCount"></span> SMS
                            </div>
                        </div>

                        <!-- Message Type Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Message Type</label>
                            <div class="flex items-center space-x-6 text-sm text-gray-700">
                                <label class="inline-flex items-center">
                                    <input type="radio" value="template" x-model="messageMode" @change="handleMessageModeChange('template')"
                                           class="text-green-600 border-gray-300 focus:ring-green-500">
                                    <span class="ml-2">Use Template Message</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" value="custom" x-model="messageMode" @change="handleMessageModeChange('custom')"
                                           class="text-green-600 border-gray-300 focus:ring-green-500">
                                    <span class="ml-2">Custom Message</span>
                                </label>
                            </div>
                        </div>

                        <!-- Custom Message Composer -->
                        <div x-show="messageMode === 'custom'" class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Custom Message</label>
                            <textarea x-model="customMessage" @input="validateCustomMessage()"
                                      rows="4"
                                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm"
                                      :class="customValidation.is_valid ? 'border-gray-200' : 'border-red-300'"
                                      placeholder="Type your message here...&#10;Variables like {student_name} and {batch_name} are supported."></textarea>
                            <div class="mt-2 flex justify-between items-center text-sm">
                                <div class="text-gray-600">
                                    <i class="fas fa-keyboard mr-1"></i>
                                    <span class="font-medium" x-text="customMessage.length"></span> actual chars
                                </div>
                                <div :class="customValidation.remaining >= 30 ? 'text-green-600' : customValidation.remaining >= 10 ? 'text-yellow-600' : 'text-red-600'">
                                    <i class="fas fa-tachometer-alt mr-1"></i>
                                    <span class="font-medium" x-text="customValidation.remaining"></span> remaining
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                Bengali characters count as 2. Keep the message within 130 characters to stay within a single SMS.
                            </div>
                            <div x-show="!customValidation.is_valid" class="mt-3 bg-red-50 border border-red-200 rounded-lg p-3 flex items-start">
                                <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                                <div class="text-sm text-red-700">
                                    <strong>Exceeds limit!</strong> Reduce by <span x-text="Math.abs(customValidation.remaining)"></span> characters.
                                </div>
                            </div>
                        </div>

                        <!-- Batch Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Select Batch</label>
                                <select x-model="selectedBatchId" @change="loadBatchStudents()" 
                                        class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <option value="">Choose a batch...</option>
                                    <template x-for="batch in batches" :key="batch.id">
                                        <option :value="batch.id" x-text="batch.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Recipients</label>
                                <select x-model="recipientType" @change="updateRecipientCount()" 
                                        :disabled="!selectedBatchId"
                                        class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 disabled:bg-gray-100">
                                    <option value="all">Full Batch</option>
                                    <option value="individual">Select Individual Students</option>
                                </select>
                            </div>
                        </div>

                        <!-- Individual Student Selection -->
                        <div x-show="recipientType === 'individual' && batchStudents.length > 0" class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Students</label>
                            <div class="max-h-48 overflow-y-auto border-2 border-gray-200 rounded-lg p-3 bg-white">
                                <template x-for="student in batchStudents" :key="student.id">
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" :value="student.id" x-model="selectedStudentIds" @change="updateRecipientCount()"
                                               class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <span class="ml-3 text-sm text-gray-700" x-text="student.full_name || student.first_name + ' ' + student.last_name"></span>
                                        <span class="ml-2 text-xs text-gray-500" x-text="'(' + (student.phone || student.phoneNumber || 'No phone') + ')'"></span>
                                    </label>
                                </template>
                            </div>
                        </div>

                        <!-- SMS Calculation Summary -->
                        <div class="bg-white rounded-lg border-2 border-green-200 p-4 mb-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-xs text-gray-500 uppercase">Recipients</div>
                                    <div class="text-2xl font-bold text-gray-800" x-text="recipientCount"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 uppercase">Chars/SMS</div>
                                    <div class="text-2xl font-bold text-gray-800" x-text="currentMessageValidation.char_count + '/130'"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 uppercase">Total SMS</div>
                                    <div class="text-2xl font-bold text-blue-600" x-text="totalSMSToSend"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 uppercase">After Send</div>
                                    <div class="text-2xl font-bold" :class="remainingBalance >= 0 ? 'text-green-600' : 'text-red-600'" 
                                         x-text="remainingBalance"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Messages -->
                        <div x-show="remainingBalance < 0" class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                            <span class="text-sm text-red-700 font-medium">Insufficient balance! You need <span x-text="Math.abs(remainingBalance)"></span> more SMS credits.</span>
                        </div>

                        <div x-show="recipientCount === 0 && selectedBatchId" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                            <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                            <span class="text-sm text-yellow-700 font-medium">Please select at least one recipient to send SMS.</span>
                        </div>

                        <!-- Send Button -->
                        <div class="flex justify-end">
                            <button @click="sendBulkSMS()" 
                                    :disabled="!canSendBulkSMS"
                                    class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed transition-all font-semibold shadow-lg">
                                <span x-show="!sending"><i class="fas fa-paper-plane mr-2"></i>Send SMS to <span x-text="recipientCount"></span> Recipients</span>
                                <span x-show="sending"><i class="fas fa-spinner fa-spin mr-2"></i>Sending...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SMS History Footer -->
            <div class="bg-white border-t p-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-gray-800 text-sm">Recent SMS Activity</h4>
                    <button @click="loadSMSLogs()" class="text-xs text-blue-600 hover:text-blue-700">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                <div class="flex space-x-4 overflow-x-auto">
                    <template x-for="log in smsLogs.slice(0, 5)" :key="log.id">
                        <div class="flex-shrink-0 bg-gray-50 rounded-lg p-3 w-64 border">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-medium text-gray-700" x-text="log.phoneNumber"></span>
                                <span class="text-xs px-2 py-1 rounded-full" 
                                      :class="log.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                      x-text="log.status === 'success' ? 'Sent' : 'Failed'"></span>
                            </div>
                            <div class="text-xs text-gray-600 line-clamp-2" x-text="log.message"></div>
                            <div class="text-xs text-gray-400 mt-1" x-text="formatDateTime(log.timestamp)"></div>
                        </div>
                    </template>
                    <div x-show="smsLogs.length === 0" class="text-center text-gray-400 text-sm py-4 w-full">
                        <i class="fas fa-inbox text-2xl mb-2"></i>
                        <p>No SMS history yet</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function smsManagement() {
    return {
        templates: [],
        smsLogs: [],
        smsCount: 0,
        selectedTemplateId: null,
        editingTemplate: {
            id: '',
            name: '',
            message: '',
            variables: []
        },
        editValidation: {
            char_count: 0,
            max_characters: 130,
            remaining: 130,
            is_valid: true
        },
        saving: false,
        sending: false,
        
        // Batch and student selection
        batches: [],
        selectedBatchId: '',
        batchStudents: [],
        recipientType: 'all', // 'all' or 'individual'
        selectedStudentIds: [],
        recipientCount: 0,
        messageMode: 'template',
        customMessage: '',
        customValidation: {
            char_count: 0,
            max_characters: 130,
            remaining: 130,
            is_valid: true
        },

        // Computed properties
        get totalSMSToSend() {
            return this.recipientCount; // 1 SMS per recipient
        },

        get remainingBalance() {
            return this.smsCount - this.totalSMSToSend;
        },

        get currentMessageValidation() {
            return this.messageMode === 'custom' ? this.customValidation : this.editValidation;
        },

        get canSendBulkSMS() {
            if (!this.selectedBatchId || this.recipientCount === 0 || this.remainingBalance < 0 || this.sending) {
                return false;
            }
            if (this.messageMode === 'custom') {
                return !!this.customMessage.trim() && this.customValidation.is_valid;
            }
            return !!this.selectedTemplateId && this.editValidation.is_valid;
        },

        async loadData() {
            await this.loadTemplates();
            await this.loadBalance();
            await this.loadSMSLogs();
            await this.loadBatches();
            // Auto-select first template
            if (this.templates.length > 0) {
                this.selectTemplate(this.templates[0].id);
            }
        },

        async loadBatches() {
            try {
                const response = await fetch('/api/batches');
                if (!response.ok) {
                    console.error('Failed to load batches - Response not OK:', response.status);
                    this.batches = [];
                    return;
                }

                const result = await response.json();
                console.log('Batches API response:', result);

                let batchesPayload = null;
                if (Array.isArray(result)) {
                    batchesPayload = result;
                } else if (Array.isArray(result?.data)) {
                    batchesPayload = result.data;
                } else if (Array.isArray(result?.data?.items)) {
                    batchesPayload = result.data.items;
                } else if (Array.isArray(result?.data?.batches)) {
                    batchesPayload = result.data.batches;
                }

                this.batches = batchesPayload || [];
                console.log('Loaded batches:', this.batches);
            } catch (error) {
                console.error('Failed to load batches:', error);
                this.batches = [];
            }
        },

        async loadBatchStudents() {
            if (!this.selectedBatchId) {
                this.batchStudents = [];
                this.selectedStudentIds = [];
                this.recipientCount = 0;
                return;
            }

            try {
                const response = await fetch(`/api/batches/${this.selectedBatchId}/students`);
                if (!response.ok) {
                    console.error('Failed to load students - Response not OK:', response.status);
                    this.batchStudents = [];
                    return;
                }

                const result = await response.json();
                console.log('Batch students API response:', result);

                let studentsPayload = null;
                if (Array.isArray(result)) {
                    studentsPayload = result;
                } else if (Array.isArray(result?.data)) {
                    studentsPayload = result.data;
                } else if (Array.isArray(result?.data?.students)) {
                    studentsPayload = result.data.students;
                } else if (Array.isArray(result?.students)) {
                    studentsPayload = result.students;
                }

                this.batchStudents = studentsPayload || [];
                console.log('Loaded students:', this.batchStudents);
                this.selectedStudentIds = [];
                this.recipientType = 'all';
                this.updateRecipientCount();
            } catch (error) {
                console.error('Failed to load batch students:', error);
                this.batchStudents = [];
            }
        },

        updateRecipientCount() {
            if (!this.selectedBatchId) {
                this.recipientCount = 0;
                return;
            }

            if (this.recipientType === 'all') {
                this.recipientCount = this.batchStudents.length;
            } else {
                this.recipientCount = this.selectedStudentIds.length;
            }
        },

        async sendBulkSMS() {
            const selectedBatchNumeric = Number(this.selectedBatchId);
            if (!selectedBatchNumeric) {
                showToast('Please select a batch', 'error');
                return;
            }

            if (this.recipientCount === 0) {
                showToast('Please select at least one recipient', 'error');
                return;
            }

            const useCustomMessage = this.messageMode === 'custom';

            if (useCustomMessage) {
                if (!this.customMessage.trim()) {
                    showToast('Please enter a custom message', 'error');
                    return;
                }
                await this.validateCustomMessage();
                if (!this.customValidation.is_valid) {
                    showToast('Custom message exceeds the 130 character limit', 'error');
                    return;
                }
            } else {
                if (!this.selectedTemplateId) {
                    showToast('Please select a template', 'error');
                    return;
                }
                if (!this.editValidation.is_valid) {
                    showToast('Template message exceeds the 130 character limit', 'error');
                    return;
                }
            }

            if (this.remainingBalance < 0) {
                showToast('Insufficient SMS balance!', 'error');
                return;
            }

            if (!confirm(`Send SMS to ${this.recipientCount} recipients?\nThis will use ${this.totalSMSToSend} SMS credits.`)) {
                return;
            }

            this.sending = true;
            try {
                const studentIds = this.recipientType === 'individual'
                    ? this.selectedStudentIds.map(id => Number(id)).filter(id => !Number.isNaN(id))
                    : [];

                const payload = {
                    batch_id: selectedBatchNumeric,
                    recipient_type: this.recipientType,
                    student_ids: studentIds,
                    use_custom_message: useCustomMessage
                };

                if (useCustomMessage) {
                    payload.custom_message = this.customMessage.trim();
                } else {
                    payload.template_id = this.selectedTemplateId;
                }

                console.log('üì§ Sending bulk SMS with payload:', payload);

                // Try authenticated endpoint first
                let response = await fetch('/api/sms/send-bulk', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // If auth fails, try no-auth endpoint
                if (!response.ok && response.status === 403) {
                    console.log('‚ö†Ô∏è Auth failed, trying send-bulk-noauth endpoint');
                    response = await fetch('/api/sms/send-bulk-noauth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const result = await response.json();
                console.log('üì® SMS Send Result:', result);
                
                if (response.ok && result.success) {
                    const sentCount = result?.data?.sent ?? this.recipientCount;
                    showToast(`‚úÖ SMS sent successfully to ${sentCount} recipients!`, 'success');
                    await this.loadBalance();
                    await this.loadSMSLogs();
                    this.selectedBatchId = '';
                    this.batchStudents = [];
                    this.selectedStudentIds = [];
                    this.recipientType = 'all';
                    this.recipientCount = 0;
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    console.error('‚ùå SMS Send Failed:', errorMsg);
                    showToast('Failed to send SMS: ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('‚ùå Failed to send SMS - Exception:', error);
                showToast('Failed to send SMS: ' + error.message, 'error');
            } finally {
                this.sending = false;
            }
        },

        async loadTemplates() {
            try {
                const response = await fetch('/api/sms/templates');
                if (response.ok) {
                    this.templates = await response.json();
                }
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        },

        async loadBalance() {
            try {
                console.log('üîç Loading SMS balance...');
                
                // Try the authenticated endpoint first (with cache busting)
                let response = await fetch('/api/sms/balance?_=' + Date.now(), {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                
                console.log('Auth endpoint response status:', response.status);
                
                // If auth fails, try the no-auth endpoint
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Auth failed, trying balance-check endpoint');
                    response = await fetch('/api/sms/balance-check?_=' + Date.now(), {
                        cache: 'no-cache'
                    });
                    console.log('Balance-check endpoint response status:', response.status);
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì¶ Full response:', result);
                    
                    // Handle different response structures
                    let balance = 0;
                    if (result.data && typeof result.data.balance !== 'undefined') {
                        balance = result.data.balance;
                    } else if (typeof result.balance !== 'undefined') {
                        balance = result.balance;
                    }
                    
                    this.smsCount = balance;
                    console.log('‚úÖ SMS Balance loaded:', this.smsCount);
                } else {
                    console.error('‚ùå Failed to load balance - Status:', response.status);
                    this.smsCount = 0;
                }
            } catch (error) {
                console.error('‚ùå Failed to load balance - Error:', error);
                this.smsCount = 0;
            }
        },

        async loadSMSLogs() {
            try {
                const response = await fetch('/api/sms/logs');
                if (response.ok) {
                    const data = await response.json();
                    this.smsLogs = Array.isArray(data) ? data : (data.logs || []);
                }
            } catch (error) {
                console.error('Failed to load SMS logs:', error);
                this.smsLogs = [];
            }
        },

        selectTemplate(templateId) {
            const template = this.templates.find(t => t.id === templateId);
            if (template) {
                this.selectedTemplateId = templateId;
                this.editingTemplate = {
                    id: template.id,
                    name: template.name,
                    message: template.message,
                    variables: template.variables || [],
                    category: template.category
                };
                this.validateEditMessage();
            }
        },

        getCurrentTemplate() {
            return this.templates.find(t => t.id === this.selectedTemplateId);
        },

        insertVariable(variable) {
            const cursorPos = document.querySelector('textarea')?.selectionStart || this.editingTemplate.message.length;
            const text = this.editingTemplate.message;
            const before = text.substring(0, cursorPos);
            const after = text.substring(cursorPos);
            this.editingTemplate.message = before + `{${variable}}` + after;
            this.validateEditMessage();
        },

        async validateEditMessage() {
            if (!this.editingTemplate.message) {
                this.editValidation = {
                    char_count: 0,
                    max_characters: 130,
                    remaining: 130,
                    is_valid: true
                };
                return;
            }

            try {
                const response = await fetch('/api/sms/validate-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: this.editingTemplate.message })
                });

                if (response.ok) {
                    const result = await response.json();
                    // The API returns data wrapped in a success response
                    this.editValidation = result.data || result;
                }
            } catch (error) {
                console.error('Failed to validate message:', error);
            }
        },

        handleMessageModeChange(mode) {
            this.messageMode = mode;
            if (mode === 'custom') {
                this.validateCustomMessage();
            }
        },

        async validateCustomMessage() {
            if (!this.customMessage) {
                this.customValidation = {
                    char_count: 0,
                    max_characters: 130,
                    remaining: 130,
                    is_valid: true
                };
                return;
            }

            try {
                const response = await fetch('/api/sms/validate-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: this.customMessage })
                });

                if (response.ok) {
                    const result = await response.json();
                    this.customValidation = result.data || result;
                }
            } catch (error) {
                console.error('Failed to validate custom message:', error);
            }
        },

        previewTemplate() {
            let message = this.editingTemplate.message || '';
            const today = new Date().toLocaleDateString('en-GB');
            
            message = message.replace(/{student_name}/g, 'Ahmed Hassan');
            message = message.replace(/{batch_name}/g, 'Batch A');
            message = message.replace(/{date}/g, today);
            message = message.replace(/{subject}/g, 'Mathematics');
            message = message.replace(/{marks}/g, '85');
            message = message.replace(/{total}/g, '100');
            
            return message || 'Your preview will appear here...';
        },

        async saveTemplate() {
            if (!this.editValidation.is_valid) {
                showToast('Message exceeds character limit', 'error');
                return;
            }

            this.saving = true;
            try {
                const response = await fetch(`/api/sms/templates/${this.editingTemplate.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: this.editingTemplate.message
                    })
                });

                if (response.ok) {
                    await this.loadTemplates();
                    showToast('‚úÖ Template saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast('Failed to save: ' + (error.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Failed to save template:', error);
                showToast('Failed to save template', 'error');
            } finally {
                this.saving = false;
            }
        },

        formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    };
}
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
